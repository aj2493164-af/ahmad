<!DOCTYPE html>
<html lang="ps">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Ø²Ù… Ø²Ù… Ù„Ø¨Ù†ÛŒØ§Øª â€” ÙˆØ±ÚÙ†ÛŒ Ø§Ùˆ Ù…ÛŒØ§Ø´ØªÙ†Û Ø­Ø³Ø§Ø¨</title>
<style>
:root{--blue:#0b79c1;--dark:#063a5b;--card:#fff;--muted:#6b7280}
html,body{height:100%;margin:0;font-family: "Segoe UI", Roboto, "Noto Naskh Arabic", Arial;background:#e8f6ff;color:#062a3a;direction:rtl}
header{background:linear-gradient(90deg,var(--blue),#0a6da8);color:#fff;padding:14px 16px;text-align:center}
.container{max-width:1000px;margin:16px auto;padding:12px}
.card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 20px rgba(9,30,63,0.06);margin-bottom:14px}
label{display:block;font-weight:700;margin:8px 0 4px}
input,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid #d6eaf8;font-size:15px;box-sizing:border-box}
button{background:var(--blue);color:#fff;border:0;cursor:pointer;font-weight:700;margin-top:6px}
.small{font-size:13px;color:var(--muted)}
.row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
.col{flex:1 1 200px;min-width:150px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #e6f3fb;padding:8px;text-align:center;font-size:14px}
th{background:#f0fbff;font-weight:800}
.stats{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
.stat{background:#f7fcff;padding:10px;border-radius:8px;flex:1;min-width:140px;text-align:center}
@media(max-width:720px){.row{flex-direction:column}.col{min-width:100%}input,select,button{font-size:16px;padding:12px}th,td{font-size:13px;padding:6px}}
</style>
</head>
<body>
<header>
  <div style="font-size:20px">ğŸ“¦ Ø²Ù… Ø²Ù… Ù„Ø¨Ù†ÛŒØ§Øª â€” ÙˆØ±ÚÙ†ÛŒ Ø§Ùˆ Ù…ÛŒØ§Ø´ØªÙ†Û Ø­Ø³Ø§Ø¨</div>
  <div class="small" style="margin-top:6px">Ù‡Ø±Ù‡ ÙˆØ±Ú Ø®Ù¾Ù„ Ø´ÛŒÙ¼ â€” Ø³Ø±Ù…Ø§ÛŒÙ‡ØŒ Ù…ØµØ±Ù Ø§Ùˆ Ù‚Ø±Ø¶Ù‡ Ø¯ÙˆØ§Ú“Ù‡ ÙˆØ±ÚÙŠ Ø§Ùˆ Ù…ÛŒØ§Ø´ØªÙŠ ÚšÚ©Ø§Ø±Ù‡ Ø¯ÙŠ</div>
</header>

<div class="container">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h3>Ù†Ù†ÙˆØªÙ„</h3>
    <div class="row">
      <div class="col"><label>Ú©Ø§Ø±Ù† Ù†ÙˆÙ…</label><input id="loginUser" placeholder="Ù…Ø«Ø§Ù„: admin"></div>
      <div class="col"><label>Ø±Ù…Ø²</label><input id="loginPass" type="password" placeholder="Ø±Ù…Ø²"></div>
      <div style="flex:0 0 140px"><button onclick="doLogin()">Ù†Ù†ÙˆØªÙ„</button></div>
    </div>
    <p class="small">Ú‰ÛŒÙØ§Ù„Ù¼ÙˆÙ†Ù‡: <b>admin/admin</b> (Ù…Ø§Ù„Ú©)ØŒ <b>manager/123</b> (Ù…Ø¯ÛŒØ±)ØŒ <b>worker/1234</b> (Ú©Ø§Ø±Ù…Ù†Ø¯)</p>
    <p id="loginMsg" class="small"></p>
  </div>

  <!-- APP -->
  <div id="appCard" class="card" style="display:none">

    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
      <div>
        <div style="font-weight:800" id="who">Ø³Ù„Ø§Ù… â€”</div>
        <div class="small" id="whoRole"></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button onclick="logout()" style="background:#e74c3c">Ø®Ø±ÙˆØ¬</button>
        <button onclick="downloadTodayCSV()">Ù†Ù† ÙˆØ±Ú CSV</button>
        <button onclick="downloadMonthlyCSV()">Ø¯Ø§ Ù…ÛŒØ§Ø´Øª CSV</button>
      </div>
    </div>

    <!-- STOCK -->
    <div class="card">
      <h3>Ú«Ø¯Ø§Ù… / Ù…Ø­ØµÙˆÙ„Ø§Øª (Ù…Ø§Ù„Ú©/Ù…Ø¯ÛŒØ± Ø§Ø¶Ø§ÙÙ‡ Ú©ÙˆÙ„ÛŒ Ø´ÙŠ)</h3>
      <div class="row">
        <div class="col"><label>Ù…Ø­ØµÙˆÙ„ Ù†ÙˆÙ…</label><input id="prodName" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø´ÛŒØ¯Û"></div>
        <div class="col"><label>Ù…Ù‚Ø¯Ø§Ø± (Ø¹Ø¯Ø¯ÙŠ)</label><input id="prodQty" type="number" min="0" placeholder="Ù…Ù‚Ø¯Ø§Ø±"></div>
        <div class="col"><label>Ù‚ÛŒÙ…Øª Ø§Ø®ÛŒØ³ØªÙ„Ùˆ (ÙÛŒ)</label><input id="prodBuy" type="number" min="0" placeholder="ÙÛŒ Ù‚ÛŒÙ…Øª"></div>
        <div style="flex:0 0 140px"><label style="visibility:hidden">Ø§Ø¶Ø§ÙÙ‡</label><button id="btnAddProd" onclick="addOrUpdateProduct()">Ø§Ø¶Ø§ÙÙ‡ / ØªØ§Ø²Ù‡</button></div>
      </div>

      <div style="margin-top:12px">
        <table>
          <thead><tr><th>Ù…Ø­ØµÙˆÙ„</th><th>Ù…Ù‚Ø¯Ø§Ø±</th><th>Ù‚ÛŒÙ…Øª Ø§Ø®ÛŒØ³ØªÙ„Ùˆ</th><th>Ø§Ø±Ø²ÚšØª (Ù…Ù‚Ø¯Ø§Ø± Ã— ÙÛŒ)</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
          <tbody id="stockTable"></tbody>
        </table>
        <div class="small" style="margin-top:8px">Ø³ØªØ§Ø³Ùˆ Ø³Ø±Ù…Ø§ÛŒÙ‡ (Ú«Ø¯Ø§Ù… Ø§Ø±Ø²ÚšØª): <b id="myInvestment">0</b> Ø§ÙØºØ§Ù†Û</div>
      </div>
    </div>

    <!-- SALE -->
    <div class="card">
      <h3>Ù¾Ù„ÙˆØ± Ø«Ø¨Øª (Ú©Ø§Ø±Ù…Ù†Ø¯ Ù¾Ù„ÙˆØ± Ø«Ø¨ØªÙˆÙŠ)</h3>
      <div class="row">
        <div class="col"><label>Ù†ÛŒÙ¼Ù‡ (Ù†Ù† ÙˆØ±Ú Ø´ÛŒÙ¼ Ú©Ø§Ø±ÙˆÙ„)</label><input id="saleDate" disabled></div>
        <div class="col"><label>Ù…Ø­ØµÙˆÙ„</label><select id="saleProduct"></select></div>
        <div class="col"><label>Ù…Ù‚Ø¯Ø§Ø±</label><input id="saleQty" type="number" min="1" placeholder="Ù…Ù‚Ø¯Ø§Ø±"></div>
        <div class="col"><label>ÙÛŒ Ù‚ÛŒÙ…Øª (Ù¾Ù„ÙˆØ±)</label><input id="salePrice" type="number" min="0" placeholder="ÙÛŒ Ù‚ÛŒÙ…Øª"></div>
        <div class="col"><label>Ù‚Ø±Ø¶Ù‡</label><input id="saleDebt" type="number" min="0" value="0"></div>
        <div style="flex:0 0 150px"><label style="visibility:hidden">Ø«Ø¨Øª</label><button onclick="recordSale()">Ø«Ø¨Øª Ù¾Ù„ÙˆØ±</button></div>
      </div>
    </div>

    <!-- EXPENSE -->
    <div class="card">
      <h3>Ù…ØµØ§Ø±Ù Ø«Ø¨Øª</h3>
      <div class="row">
        <div class="col"><label>Ø¯ Ù…ØµØ±Ù Ù†ÙˆÙ…</label><input id="expenseName" placeholder="Ù„Ú©Ù‡ Ú©Ø±Ø§ÛŒÙ‡ ÙŠØ§ Ø¨Ø±Ù‚"></div>
        <div class="col"><label>Ù…Ù‚Ø¯Ø§Ø± (Ø§ÙØºØ§Ù†ÛŒ)</label><input id="expenseAmount" type="number" min="0" placeholder="Ù…Ù‚Ø¯Ø§Ø±"></div>
        <div style="flex:0 0 140px"><label style="visibility:hidden">Ø«Ø¨Øª</label><button onclick="addExpense()">Ø«Ø¨Øª Ù…ØµØ±Ù</button></div>
      </div>

      <div style="margin-top:12px">
        <table>
          <thead><tr><th>Ù†ÛŒÙ¼Ù‡</th><th>Ù…ØµØ±Ù</th><th>Ù…Ù‚Ø¯Ø§Ø±</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
          <tbody id="expenseTable"></tbody>
        </table>
      </div>
    </div>

    <!-- REPORTS -->
    <div class="card">
      <h3>Ø±Ø§Ù¾ÙˆØ±ÙˆÙ†Ù‡</h3>

      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:220px" class="stat card">
          <div class="small">ÙˆØ±ÚÙ†ÛŒ â€” Ù¼ÙˆÙ„ Ø¹Ø§ÛŒØ¯</div>
          <div id="dayIncome" style="font-weight:800;font-size:18px">0</div>
        </div>
        <div style="flex:1;min-width:220px" class="stat card">
          <div class="small">ÙˆØ±ÚÙ†ÛŒ â€” Ù¼ÙˆÙ„ Ù…ØµØ±Ù</div>
          <div id="dayExpense" style="font-weight:800;font-size:18px">0</div>
        </div>
        <div style="flex:1;min-width:220px" class="stat card">
          <div class="small">ÙˆØ±ÚÙ†ÛŒ â€” Ù¼ÙˆÙ„ Ù‚Ø±Ø¶Ù‡</div>
          <div id="dayDebt" style="font-weight:800;font-size:18px">0</div>
        </div>
        <div style="flex:1;min-width:220px" class="stat card">
          <div class="small">ÙˆØ±ÚÙ†ÛŒ â€” Ø®Ø§Ù„Øµ Ú«Ù¼Ù‡</div>
          <div id="dayProfit" style="font-weight:800;font-size:18px">0</div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:220px" class="stat card">
          <div class="small">Ù…ÛŒØ§Ø´ØªÙ†ÛŒ â€” Ù¼ÙˆÙ„ Ø¹Ø§ÛŒØ¯</div>
          <div id="monthIncome" style="font-weight:800;font-size:18px">0</div>
        </div>
        <div style="flex:1;min-width:220px" class="stat card">
          <div class="small">Ù…ÛŒØ§Ø´ØªÙ†ÛŒ â€” Ù¼ÙˆÙ„ Ù…ØµØ±Ù</div>
          <div id="monthExpense" style="font-weight:800;font-size:18px">0</div>
        </div>
        <div style="flex:1;min-width:220px" class="stat card">
          <div class="small">Ù…ÛŒØ§Ø´ØªÙ†ÛŒ â€” Ù¼ÙˆÙ„ Ù‚Ø±Ø¶Ù‡</div>
          <div id="monthDebt" style="font-weight:800;font-size:18px">0</div>
        </div>
        <div style="flex:1;min-width:220px" class="stat card">
          <div class="small">Ù…ÛŒØ§Ø´ØªÙ†ÛŒ â€” Ø®Ø§Ù„Øµ Ú«Ù¼Ù‡</div>
          <div id="monthProfit" style="font-weight:800;font-size:18px">0</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Ø³Ø±Ù…Ø§ÛŒÙ‡ (Ú«Ø¯Ø§Ù… Ø§Ø±Ø²ÚšØª): <b id="investmentDisplay">0</b> Ø§ÙØºØ§Ù†Û</div>
      </div>

    </div>

    <!-- Today's sheet table -->
    <div class="card">
      <h3>Ø¯ Ù†Ù† ÙˆØ±ÚÛ Ø´ÛŒÙ¼ â€” Ø«Ø¨Øª Ø´ÙˆÙŠ Ù¾Ù„ÙˆØ±ÙˆÙ†Ù‡</h3>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <div class="small">Ù†ÛÙ¼Ù‡: <b id="currentSheet"></b></div>
        <div style="margin-left:auto">
          <label>Ù†ÛŒÙ¼Ù‡ ÙˆÙ¼Ø§Ú©Ø¦ Ø¯ Ú©ØªÙˆÙ† Ù„Ù¾Ø§Ø±Ù‡</label>
          <select id="sheetSelect" onchange="loadSheet(this.value)"></select>
        </div>
      </div>

      <table>
        <thead><tr><th>ÙˆØ®Øª</th><th>Ù…Ø­ØµÙˆÙ„</th><th>Ù…Ù‚Ø¯Ø§Ø±</th><th>ÙÛŒ Ù‚ÛŒÙ…Øª</th><th>Ù¼ÙˆÙ„</th><th>Ù‚Ø±Ø¶Ù‡</th><th>Ú«Ù¼Ù‡</th></tr></thead>
        <tbody id="recordsTable"></tbody>
      </table>
    </div>

  </div> <!-- end appCard -->

</div> <!-- end container -->

<script>
/* ---------- Helpers & storage keys ---------- */
const TODAY_ISO = new Date().toISOString().slice(0,10); // YYYY-MM-DD
function keySheet(date){ return 'zz_sheet_' + date; }
function keyExpenses(date){ return 'zz_expenses_' + date; }
function saveLS(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function loadLS(k,def){ try{ const s=localStorage.getItem(k); return s?JSON.parse(s):def; }catch(e){ return def; } }

/* ---------- Default users & init ---------- */
let users = loadLS('zz_users', [
  {username:'admin', password:'admin', role:'Ù…Ø§Ù„Ú©'},
  {username:'manager', password:'123', role:'Ù…Ø¯ÛŒØ±'},
  {username:'worker', password:'1234', role:'Ú©Ø§Ø±Ù…Ù†Ø¯'}
]);
saveLS('zz_users', users);

let currentUser = null;
let stock = loadLS('zz_stock', {}); // {name:{quantity, buyPrice}}
let sheetDates = loadLS('zz_sheet_dates', []);

/* ensure today's sheet exists */
function ensureTodaySheet(){
  const k = keySheet(TODAY_ISO);
  if(!localStorage.getItem(k)){
    const sheet = { date: TODAY_ISO, createdBy: null, records: [], totals:{income:0, expense:0, debt:0, profit:0} };
    saveLS(k, sheet);
  }
  if(!sheetDates.includes(TODAY_ISO)){ sheetDates.unshift(TODAY_ISO); saveLS('zz_sheet_dates', sheetDates); }
}
ensureTodaySheet();

/* ---------- Login ---------- */
function doLogin(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  const found = users.find(x=>x.username===u && x.password===p);
  const msg = document.getElementById('loginMsg');
  if(!found){ msg.innerText = 'Ù†Ø§Ø³Ù… Ú©Ø§Ø±Ù† Ù†ÙˆÙ… ÛŒØ§ Ø±Ù…Ø²'; msg.style.color='red'; return; }
  currentUser = found;
  msg.innerText='';
  document.getElementById('loginCard').style.display='none';
  document.getElementById('appCard').style.display='block';
  document.getElementById('who').innerText = `Ø³Ù„Ø§Ù…ØŒ ${currentUser.username}`;
  document.getElementById('whoRole').innerText = currentUser.role;
  if(currentUser.role==='Ú©Ø§Ø±Ù…Ù†Ø¯'){ document.getElementById('btnAddProd').disabled = true; }
  document.getElementById('saleDate').value = TODAY_ISO;
  document.getElementById('currentSheet').innerText = TODAY_ISO;
  refreshUI();
}

/* ---------- Stock functions ---------- */
function saveStock(){ saveLS('zz_stock', stock); }
function addOrUpdateProduct(){
  if(!currentUser || (currentUser.role !== 'Ù…Ø§Ù„Ú©' && currentUser.role !== 'Ù…Ø¯ÛŒØ±')){ alert('ÛŒÙˆØ§Ø²Û Ù…Ø§Ù„Ú© ÛŒØ§ Ù…Ø¯ÛŒØ± Ú©ÙˆÙ„ÛŒ Ø´ÙŠ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø§Ø¶Ø§ÙÙ‡/ØªØ§Ø²Ù‡ Ú©Ú“ÙŠ'); return; }
  const name = document.getElementById('prodName').value.trim();
  const qty = parseFloat(document.getElementById('prodQty').value);
  const buy = parseFloat(document.getElementById('prodBuy').value);
  if(!name || isNaN(qty) || isNaN(buy)){ alert('Ù¼ÙˆÙ„Û Ø¨Ø±Ø®Û ØµØ­ÛŒØ­ Ú‰Ú©Û Ú©Ú“Ø¦'); return; }
  if(!stock[name]) stock[name] = { quantity: 0, buyPrice: buy };
  stock[name].quantity += qty;
  stock[name].buyPrice = buy;
  saveStock(); clearProdInputs(); refreshUI();
  alert('Ù…Ø­ØµÙˆÙ„ Ø«Ø¨Øª/ØªØ§Ø²Ù‡ Ø´Ùˆ: ' + name);
}
function clearProdInputs(){ document.getElementById('prodName').value=''; document.getElementById('prodQty').value=''; document.getElementById('prodBuy').value=''; }
function editStock(name){ const s = stock[name]; const q = prompt('Ù†ÙˆÛŒ Ù…Ù‚Ø¯Ø§Ø±:', s.quantity); const b = prompt('Ù†ÙˆÛŒ ÙÛŒ Ù‚ÛŒÙ…Øª:', s.buyPrice); const qi = parseFloat(q), bi = parseFloat(b); if(isNaN(qi)||isNaN(bi)){ alert('Ù…Ø¹ØªØ¨Ø± Ø§Ø±Ø²ÚšØª'); return; } stock[name]={quantity:qi,buyPrice:bi}; saveStock(); refreshUI(); }
function deleteStock(name){ if(!confirm('Ø­Ø°Ù ÛŒØ§Ø³ØªØŸ '+name)) return; delete stock[name]; saveStock(); refreshUI(); }

/* ---------- populate UI ---------- */
function refreshUI(){
  populateStockTable();
  populateSaleSelect();
  refreshSheetList();
  calculateInvestment();
  loadSheet(TODAY_ISO);
  calculateDayAndMonth();
}
function populateStockTable(){
  const tbody = document.getElementById('stockTable'); tbody.innerHTML='';
  for(const name of Object.keys(stock)){
    const row = tbody.insertRow();
    row.insertCell(0).innerText = name;
    row.insertCell(1).innerText = stock[name].quantity;
    row.insertCell(2).innerText = stock[name].buyPrice;
    row.insertCell(3).innerText = (stock[name].quantity * stock[name].buyPrice).toFixed(2);
    const ops = row.insertCell(4);
    ops.innerHTML = `<button onclick="editStock('${encodeURIComponent(name)}')">Ø§ÛŒÚ‰ÛŒÙ¼</button> <button onclick="deleteStock('${encodeURIComponent(name)}')">Ø­Ø°Ù</button>`;
  }
  // decode in callbacks
  // update investment display
  calculateInvestment();
}
function populateSaleSelect(){
  const sel = document.getElementById('saleProduct'); sel.innerHTML='';
  for(const name of Object.keys(stock)){
    const opt = document.createElement('option'); opt.value = name; opt.text = `${name} (Ù…ÙˆØ¬ÙˆØ¯: ${stock[name].quantity})`; sel.appendChild(opt);
  }
}

/* ---------- Sheets management ---------- */
function refreshSheetList(){
  sheetDates = loadLS('zz_sheet_dates', sheetDates);
  if(!sheetDates.includes(TODAY_ISO)){ sheetDates.unshift(TODAY_ISO); saveLS('zz_sheet_dates', sheetDates); }
  const sel = document.getElementById('sheetSelect'); sel.innerHTML='';
  for(const d of sheetDates){ const o=document.createElement('option'); o.value=d; o.text=d; sel.appendChild(o); }
}

/* ensure sheet exists */
function ensureSheet(date){
  let sheet = loadLS(keySheet(date), null);
  if(!sheet){ sheet = { date, createdBy: currentUser?currentUser.username:null, records: [], totals:{income:0,expense:0, debt:0, profit:0} }; saveLS(keySheet(date), sheet); sheetDates = loadLS('zz_sheet_dates', []); if(!sheetDates.includes(date)){ sheetDates.unshift(date); saveLS('zz_sheet_dates', sheetDates); } }
  return sheet;
}

/* ---------- Sales ---------- */
function recordSale(){
  if(!currentUser){ alert('Ù„ÙˆÙ…Ú“ÛŒ Ù†Ù†ÙˆØªÙ„'); return; }
  const date = TODAY_ISO;
  const product = document.getElementById('saleProduct').value;
  const qty = parseFloat(document.getElementById('saleQty').value);
  const price = parseFloat(document.getElementById('salePrice').value);
  const debt = parseFloat(document.getElementById('saleDebt').value) || 0;
  if(!product || isNaN(qty) || isNaN(price)){ alert('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØµØ­ÛŒØ­ Ø¯Ø§Ø®Ù„ Ú©Ú“Ø¦'); return; }
  if(!stock[product] || stock[product].quantity < qty){ alert('Ù¾Ù‡ Ú«Ø¯Ø§Ù… Ú©Û Ú©Ø§ÙÛŒ Ù…Ù‚Ø¯Ø§Ø± Ù†Ø´ØªÙ‡'); return; }

  // subtract stock
  stock[product].quantity -= qty; saveStock();

  // compute totals
  const total = qty * price;
  let profit = (price - stock[product].buyPrice) * qty - debt;
  if(profit < 0) profit = 0; // Ø³ØªØ§Ø³Ùˆ ØºÙˆÚšØªÙ†Ù‡: Ù…Ù†ÙÙŠ Ù…Ù‡ ÚšÚ©Ø§Ø±Ù‡ Ú©ÙˆØ¦

  const rec = { time: new Date().toLocaleTimeString(), user: currentUser.username, product, qty, price, total, debt, profit };
  const sheet = ensureSheet(date);
  sheet.records.push(rec);
  sheet.totals.income = (sheet.totals.income || 0) + total;
  sheet.totals.debt = (sheet.totals.debt || 0) + debt;
  sheet.totals.profit = (sheet.totals.profit || 0) + profit;
  saveLS(keySheet(date), sheet);

  // also save expense totals if needed (handled in addExpense)
  refreshUI();
  // clear inputs
  document.getElementById('saleQty').value=''; document.getElementById('salePrice').value=''; document.getElementById('saleDebt').value='0';
  alert('Ù¾Ù„ÙˆØ± Ø«Ø¨Øª Ø´Ùˆ.');
}

/* ---------- Expenses ---------- */
function addExpense(){
  if(!currentUser){ alert('Ù„ÙˆÙ…Ú“ÛŒ Ù†Ù†ÙˆØªÙ„'); return; }
  const date = TODAY_ISO;
  const name = document.getElementById('expenseName').value.trim();
  const amount = parseFloat(document.getElementById('expenseAmount').value);
  if(!name || isNaN(amount)){ alert('Ø¯ Ù…ØµØ±Ù Ù†ÙˆÙ… Ø§Ùˆ Ù…Ù‚Ø¯Ø§Ø± ÙˆÙ„ÛŒÚ©Ø¦'); return; }
  const key = keyExpenses(date);
  const exps = loadLS(key, []);
  exps.push({ time: new Date().toLocaleTimeString(), name, amount, user: currentUser.username });
  saveLS(key, exps);

  // update sheet totals expense
  const sheet = ensureSheet(date);
  sheet.totals.expense = (sheet.totals.expense || 0) + amount;
  saveLS(keySheet(date), sheet);

  document.getElementById('expenseName').value=''; document.getElementById('expenseAmount').value='';
  refreshUI();
}

/* ---------- render sheet & expenses ---------- */
function loadSheet(date){
  if(!date) date = TODAY_ISO;
  document.getElementById('currentSheet').innerText = date;
  const sheet = ensureSheet(date);
  // render records table
  const tbody = document.getElementById('recordsTable'); tbody.innerHTML='';
  let sumIncome=0,sumDebt=0,sumProfit=0;
  for(const r of sheet.records){
    const row = tbody.insertRow();
    row.insertCell(0).innerText = r.time;
    row.insertCell(1).innerText = r.product;
    row.insertCell(2).innerText = r.qty;
    row.insertCell(3).innerText = r.price;
    row.insertCell(4).innerText = r.total;
    row.insertCell(5).innerText = r.debt;
    row.insertCell(6).innerText = r.profit;
    sumIncome += r.total; sumDebt += r.debt; sumProfit += r.profit;
  }
  // render expenses
  const expT = document.getElementById('expenseTable'); expT.innerHTML='';
  const exps = loadLS(keyExpenses(date), []);
  let sumExpense=0;
  for(const e of exps){
    const row = expT.insertRow();
    row.insertCell(0).innerText = e.time;
    row.insertCell(1).innerText = e.name;
    row.insertCell(2).innerText = e.amount;
    row.insertCell(3).innerHTML = `<button onclick="deleteExpense('${date}', ${exps.indexOf(e)})">Ø­Ø°Ù</button>`;
    sumExpense += e.amount;
  }
  // update totals display for this sheet
  const net = Math.max(0, sumProfit - sumExpense); // non-negative
  document.getElementById('dayIncome').innerText = sumIncome.toFixed(2);
  document.getElementById('dayExpense').innerText = sumExpense.toFixed(2);
  document.getElementById('dayDebt').innerText = sumDebt.toFixed(2);
  document.getElementById('dayProfit').innerText = net.toFixed(2);
  // set current sheet totals in storage
  sheet.totals.income = sumIncome; sheet.totals.expense = sumExpense; sheet.totals.debt = sumDebt; sheet.totals.profit = sumProfit;
  saveLS(keySheet(date), sheet);
  // set current sheet select value
  try{ document.getElementById('sheetSelect').value = date; }catch(e){}
}

/* delete expense by index */
function deleteExpense(date, idx){
  const key = keyExpenses(date);
  const arr = loadLS(key, []);
  if(idx < 0 || idx >= arr.length) return;
  if(!confirm('Ù…ØµØ±Ù Ø­Ø°Ù Ú©Ú“Ù„ Ø´ÙŠØŸ')) return;
  arr.splice(idx,1);
  saveLS(key, arr);
  // update sheet totals
  const sheet = ensureSheet(date);
  let sumExpense = arr.reduce((s,a)=>s+a.amount,0);
  sheet.totals.expense = sumExpense;
  saveLS(keySheet(date), sheet);
  refreshUI();
}

/* ---------- Investment calculation ---------- */
function calculateInvestment(){
  let total = 0;
  for(const name of Object.keys(stock)){
    total += (stock[name].quantity || 0) * (stock[name].buyPrice || 0);
  }
  document.getElementById('myInvestment').innerText = total.toFixed(2);
  document.getElementById('investmentDisplay').innerText = total.toFixed(2);
  return total;
}

/* ---------- Day & Month aggregates ---------- */
function calculateDayAndMonth(){
  // day already computed in loadSheet
  // month: iterate over sheetDates and sum those that match current month
  const monthPrefix = TODAY_ISO.slice(0,7); // YYYY-MM
  let mIncome=0, mExpense=0, mDebt=0, mProfit=0;
  sheetDates = loadLS('zz_sheet_dates', sheetDates);
  for(const d of sheetDates){
    if(d.startsWith(monthPrefix)){
      const s = loadLS(keySheet(d), null);
      if(s){
        mIncome += (s.totals.income || 0);
        mExpense += (s.totals.expense || 0);
        mDebt += (s.totals.debt || 0);
        mProfit += (s.totals.profit || 0);
      }
    }
  }
  const netMonth = Math.max(0, mProfit - mExpense);
  document.getElementById('monthIncome').innerText = mIncome.toFixed(2);
  document.getElementById('monthExpense').innerText = mExpense.toFixed(2);
  document.getElementById('monthDebt').innerText = mDebt.toFixed(2);
  document.getElementById('monthProfit').innerText = netMonth.toFixed(2);
}

/* ---------- CSV Exports ---------- */
function downloadTodayCSV(){
  const date = TODAY_ISO;
  const sheet = loadLS(keySheet(date), {records:[]});
  let csv = 'ÙˆØ®Øª,ÛŒÙˆØ²Ø±,Ù…Ø­ØµÙˆÙ„,Ù…Ù‚Ø¯Ø§Ø±,ÙÛŒ Ù‚ÛŒÙ…Øª,Ù¼ÙˆÙ„ Ù‚ÛŒÙ…Øª,Ù‚Ø±Ø¶Ù‡,Ú«Ù¼Ù‡\n';
  for(const r of sheet.records){
    csv += `${r.time},${r.user},${r.product},${r.qty},${r.price},${r.total},${r.debt},${r.profit}\n`;
  }
  csv += '\nÙ…ØµØ§Ø±Ù:\nÙˆØ®Øª,Ù…ØµØ±Ù,Ù…Ù‚Ø¯Ø§Ø±\n';
  const exps = loadLS(keyExpenses(date), []);
  for(const e of exps) csv += `${e.time},${e.name},${e.amount}\n`;
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `daily_${date}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function downloadMonthlyCSV(){
  const monthPrefix = TODAY_ISO.slice(0,7);
  let csv = 'Ù†ÛŒÙ¼Ù‡,ÙˆØ®Øª,ÛŒÙˆØ²Ø±,Ù…Ø­ØµÙˆÙ„,Ù…Ù‚Ø¯Ø§Ø±,ÙÛŒ Ù‚ÛŒÙ…Øª,Ù¼ÙˆÙ„ Ù‚ÛŒÙ…Øª,Ù‚Ø±Ø¶Ù‡,Ú«Ù¼Ù‡\n';
  sheetDates = loadLS('zz_sheet_dates', sheetDates);
  for(const d of sheetDates){
    if(d.startsWith(monthPrefix)){
      const s = loadLS(keySheet(d), {records:[]});
      for(const r of s.records) csv += `${d},${r.time},${r.user},${r.product},${r.qty},${r.price},${r.total},${r.debt},${r.profit}\n`;
      // include expenses
      const exps = loadLS(keyExpenses(d), []);
      if(exps && exps.length){
        csv += `\n${d} - Ù…ØµØ§Ø±Ù:\nÙˆØ®Øª,Ù…ØµØ±Ù,Ù…Ù‚Ø¯Ø§Ø±\n`;
        for(const e of exps) csv += `${e.time},${e.name},${e.amount}\n`;
      }
    }
  }
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `monthly_${monthPrefix}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ---------- Load sheet for selected date ---------- */
function loadSheet(date){
  if(!date) date = TODAY_ISO;
  document.getElementById('currentSheet').innerText = date;
  const sheet = ensureSheet(date);
  // show records
  const tbody = document.getElementById('recordsTable'); tbody.innerHTML='';
  for(const r of sheet.records){
    const row = tbody.insertRow();
    row.insertCell(0).innerText = r.time;
    row.insertCell(1).innerText = r.product;
    row.insertCell(2).innerText = r.qty;
    row.insertCell(3).innerText = r.price;
    row.insertCell(4).innerText = r.total;
    row.insertCell(5).innerText = r.debt;
    row.insertCell(6).innerText = r.profit;
  }
  // show expenses for that date
  const expT = document.getElementById('expenseTable'); expT.innerHTML='';
  const exps = loadLS(keyExpenses(date), []);
  for(const [i,e] of exps.entries()){
    const row = expT.insertRow();
    row.insertCell(0).innerText = e.time;
    row.insertCell(1).innerText = e.name;
    row.insertCell(2).innerText = e.amount;
    row.insertCell(3).innerHTML = `<button onclick="deleteExpense('${date}', ${i})">Ø­Ø°Ù</button>`;
  }
  // update day totals
  let sumIncome=sheet.records.reduce((s,r)=>s+r.total,0);
  let sumDebt=sheet.records.reduce((s,r)=>s+r.debt,0);
  let sumProfit=sheet.records.reduce((s,r)=>s+r.profit,0);
  let sumExp = exps.reduce((s,e)=>s+e.amount,0);
  document.getElementById('dayIncome').innerText = sumIncome.toFixed(2);
  document.getElementById('dayExpense').innerText = sumExp.toFixed(2);
  document.getElementById('dayDebt').innerText = sumDebt.toFixed(2);
  document.getElementById('dayProfit').innerText = Math.max(0, sumProfit - sumExp).toFixed(2);

  // set select value
  try{ document.getElementById('sheetSelect').value = date; }catch(e){}
}

/* ---------- logout ---------- */
function logout(){ currentUser = null; document.getElementById('appCard').style.display='none'; document.getElementById('loginCard').style.display='block'; }

/* ---------- initial UI population ---------- */
function initUI(){
  // set sale date and ensure today's sheet
  document.getElementById('saleDate').value = TODAY_ISO;
  ensureTodaySheet();
  populateStockTable();
  populateSaleSelect();
  refreshSheetList();
  loadSheet(TODAY_ISO);
  calculateInvestment();
  calculateDayAndMonth();
}
initUI();

</script>
</body>
</html>
